# Agentic Medical Device Reviewer – Technical Specification (spec.md)

## 1. Overview

This document describes the architecture and behavior of the **Agentic Medical Device Reviewer** web application implemented in `app.py`. The app is built with **Streamlit** and targets regulatory use-cases for:

- **FDA 510(k)** review support, and  
- **TFDA (Taiwan) second and third class medical device premarket application** (查驗登記) support.

It provides a **WOW UI** with multi-theme styling, multiple LLM providers, an agent-based pipeline (`agents.yaml`), and advanced features for:

- TFDA application data entry and pre-screening (預審/形式審查)  
- 510(k) intelligence and review memo drafting  
- PDF → Markdown conversion  
- Note keeping and AI “magics”  
- Agent configuration and management  

This specification assumes the code in `app.py` as given and does not modify it.

---

## 2. Technology Stack

### 2.1 Core Framework

- **Frontend / Web App**: [Streamlit](https://streamlit.io/)
- **Language**: Python 3.x

### 2.2 LLM Providers and SDKs

- **OpenAI** (`openai` Python SDK)
  - `gpt-4o-mini`
  - `gpt-4.1-mini`
- **Google Gemini** (`google-generativeai`)
  - `gemini-2.5-flash`
  - `gemini-2.5-flash-lite`
- **Anthropic** (`anthropic`)
  - `claude-3-5-sonnet-2024-10`
  - `claude-3-5-haiku-20241022`
- **Grok / xAI** (`httpx` direct REST client)
  - `grok-4-fast-reasoning`
  - `grok-3-mini`

### 2.3 Document Processing

- **PDF extraction**: `pypdf.PdfReader`
- **DOCX extraction** (optional): `python-docx` (`Document`)
- **PDF generation** (optional): `reportlab` (for text-to-PDF)

### 2.4 Data and Visualization

- **Data handling**: `pandas`
- **Charts**: `altair`
- **YAML configuration**: `PyYAML`

---

## 3. High-Level Architecture

The app is **single-page** Streamlit with multiple **tabs**:

1. Dashboard  
2. TW Premarket (TFDA premarket application)  
3. 510(k) Intelligence  
4. PDF → Markdown  
5. 510(k) Review Pipeline  
6. Note Keeper & Magics  
7. Agents Config  

The main components:

- **Global Session State** (`st.session_state`)  
  - `settings`: theme, language, default model, max_tokens, temperature  
  - `history`: LLM call logs (tab, agent, model, tokens, timestamp)  
  - `agents_cfg`: agents catalog from `agents.yaml` (or fallback)  
  - Various `tw_*`, `subm_*`, `note_*` keys storing form data and outputs  

- **LLM Routing Layer**: `call_llm()` and `get_provider()`  
  - Routes requests to appropriate provider based on model name.  
  - Uses environment variables or sidebar inputs for API keys.  

- **Agent Execution UI**: `agent_run_ui()`  
  - Generic component to run any agent defined in `agents.yaml`.  
  - Supports per-run model override, max_tokens, prompt editing, and output editing.  

- **Tab Renderers**:  
  - `render_dashboard()`  
  - `render_tw_premarket_tab()`  
  - `render_510k_tab()`  
  - `render_pdf_to_md_tab()`  
  - `render_510k_review_pipeline_tab()`  
  - `render_note_keeper_tab()`  
  - `render_agents_config_tab()`  

- **Styling and WOW UI**  
  - `apply_style()` injects dynamic CSS for:
    - Painter-inspired backgrounds
    - Light/Dark theme adjustments
    - Button and input styling
    - WOW cards (status indicators)

---

## 4. Global Settings & UI

### 4.1 Sidebar

`render_sidebar()` provides global settings:

- **Theme**: `"Light"` or `"Dark"`  
- **Language**: `"English"` or `"繁體中文"`  
- **Painter Style**: one of 20 predefined `PAINTER_STYLES`  
  - A “Jackpot!” button randomly picks a style.  
- **Model Settings**:
  - Default Model (`settings["model"]`) from `ALL_MODELS`  
  - Default `max_tokens` (1,000–120,000, default 12,000)  
  - Default `temperature` (0.0–1.0)  

- **API Keys**:
  - For OpenAI, Gemini, Anthropic, Grok  
  - If env var (e.g., `OPENAI_API_KEY`) exists, sidebar does not prompt for the key and simply shows a caption indicating “from environment”.  
  - Otherwise, provides a password input field.  
  - All keys are stored in `st.session_state["api_keys"]`.

- **Agents Catalog Upload**:
  - User can upload a custom `agents.yaml` / `agents.yml`.  
  - If parsed successfully and contains `agents` top-level key, it replaces `st.session_state["agents_cfg"]` for the session.

### 4.2 Styling

`apply_style(theme, painter_style)`:

- Composes CSS from:
  - `STYLE_CSS[painter_style]` for background.  
  - Theme-specific overrides for text color, button color, input background.  
  - WOW card / badge classes for visual dashboards.

---

## 5. LLM Routing & Agent Execution

### 5.1 LLM Routing

`call_llm(model, system_prompt, user_prompt, max_tokens, temperature, api_keys)`:

- Determines provider:
  - `get_provider()` maps the model to `"openai"`, `"gemini"`, `"anthropic"`, `"grok"`.  
- Retrieves API key from:
  - `api_keys[name]` or `os.getenv(env_var)`  
- For each provider:
  - **OpenAI**: uses `OpenAI(api_key=...)` chat.completions  
  - **Gemini**: uses `genai.GenerativeModel` with `generate_content`  
  - **Anthropic**: uses `Anthropic(...).messages.create()`  
  - **Grok**: uses `httpx` to call `https://api.x.ai/v1/chat/completions`  

Errors raise `RuntimeError` or are caught in the calling UI.

### 5.2 Agent Execution UI

`agent_run_ui(agent_id, tab_key, default_prompt, default_input_text, allow_model_override, tab_label_for_history)`:

- Reads `st.session_state["agents_cfg"]["agents"][agent_id]` when available, else uses a fallback definition.  
- Maintains a per-tab status (`pending`, `running`, `done`, `error`) and shows it via `show_status()`.  
- UI elements:
  - Prompt text area (pre-populated from `default_prompt` or previous edits)  
  - Model selectbox (defaults to agent’s model, or global default)  
  - `max_tokens` number input (defaults to agent’s or global setting)  
  - Input text area (pre-populated from `default_input_text` or previous edits)  
  - “Run Agent” button  
  - Output view mode: **Markdown** / **Plain text**  
  - Editable output text area (per view mode)  

- When executing:
  - Sets status to `"running"`  
  - Builds a concatenated `user_full` string (`user_prompt + "\n\n---\n\n" + input_text`)  
  - Calls `call_llm()` with `system_prompt` from agent config.  
  - Stores raw output in `st.session_state[f"{tab_key}_output"]`  
  - Estimates tokens (`len(input+output)/4`) and logs event via `log_event()`  
  - Status is set to `"done"` or `"error"` depending on result.  

Outputs are always editable, allowing the user to chain results between agents or modify them before reuse.

---

## 6. Dashboard

`render_dashboard()`:

- Reads `st.session_state["history"]` as a list of dicts with keys:
  - `tab`, `agent`, `model`, `tokens_est`, `ts`  
- Computes and displays:
  - **Total Runs**
  - **Unique Tabs**
  - **Approx Tokens Processed**

### 6.1 WOW Status Wall (New Visualization)

- Computes the latest run (max `ts`).  
- Renders a “WOW card” showing:
  - Tab, agent name  
  - Model, tokens estimate, timestamp  
  - A dynamic gradient color based on `tokens_est`:
    - Green for low/normal usage  
    - Orange for moderate usage (> 40k tokens)  
    - Red for high usage (> 80k tokens)  

### 6.2 Charts

- **Runs by Tab**: Altair bar chart (`x=tab`, `y=count`)  
- **Runs by Model**: Altair bar chart (`x=model`, `y=count`)  

### 6.3 Model × Tab Usage Heatmap (New Visualization)

- Aggregates `count` by (`tab`, `model`) and renders a **heatmap**:
  - Rect marks with color intensity based on usage count.  
  - Tooltips show tab, model, count.

### 6.4 Token Usage Over Time

- Time series line chart (`ts` vs `tokens_est`), colored by tab, with tooltips including agent, model.

### 6.5 Recent Activity

- Displays a data frame of the 25 most recent runs sorted by timestamp descending.

---

## 7. TW Premarket Tab (TFDA Application & Pre-screening)

`render_tw_premarket_tab()` is the most complex tab, providing:

1. Application Info Import/Export (JSON/CSV + LLM standardization)  
2. WOW Application Completeness Indicator (progress/status)  
3. Interactive Application Form (TFDA fields)  
4. Guidance ingestion  
5. Pre-screening / completeness check via agent  
6. Application document improvement via agent  

### 7.1 Application Info Import / Export

#### 7.1.1 Data Schema

`TW_APP_FIELDS` defines all standardized keys for the TFDA application:

- Identification: `doc_no`, `e_no`, `apply_date`  
- Case info: `case_type`, `device_category`, `case_kind`, `origin`, `product_class`, `similar`, `replace_flag`, `prior_app_no`  
- Device info: `name_zh`, `name_en`, `indications`, `spec_comp`, `main_cat`, `item_code`, `item_name`  
- Firm info: `uniform_id`, `firm_name`, `firm_addr`, `resp_name`, `contact_name`, `contact_tel`, `contact_fax`, `contact_email`, `confirm_match`  
- Certificates: `cert_raps`, `cert_ahwp`, `cert_other`  
- Manufacturer: `manu_type`, `manu_name`, `manu_country`, `manu_addr`, `manu_note`  
- Attachments & technical summaries:  
  - `auth_applicable`, `auth_desc`, `cfs_applicable`, `cfs_desc`, `qms_applicable`, `qms_desc`  
  - `similar_info`, `labeling_info`, `tech_file_info`  
  - `preclinical_info`, `preclinical_replace`  
  - `clinical_just`, `clinical_info`  

`build_tw_app_dict_from_session()` reads the form state into a normalized dict of this shape.

`apply_tw_app_dict_to_session(data)` writes data from the standardized dict into respective `st.session_state["tw_*"]` fields, updating the form.

#### 7.1.2 Upload

- The UI allows uploading **JSON** or **CSV**:
  - If JSON:
    - `json.load()` into `raw_data`.  
  - If CSV:
    - `pandas.read_csv()` → first row converted to dict (`orient="records"`).  

- Standardization logic:
  - If `raw_data` is a dict and already contains all `TW_APP_FIELDS`, it is assumed standardized.  
  - Otherwise:
    - Calls `standardize_tw_app_info_with_llm(raw_data)`:
      - Uses `gemini-2.5-flash` via `call_llm` with a system prompt instructing the model to map arbitrary keys to the standard schema and output pure JSON.
      - Parses the response JSON and ensures all fields exist (filling missing ones as empty or `False` for booleans).  

- After obtaining `standardized` dict:
  - `apply_tw_app_dict_to_session(standardized)` updates the form.  
  - Saves a preview in `st.session_state["tw_app_last_loaded"]`.  
  - Triggers `st.experimental_rerun()` to refresh UI with the updated values.

#### 7.1.3 Download

- Uses `build_tw_app_dict_from_session()` to capture all current form values:

  - JSON download:
    - `json.dumps(app_dict, ensure_ascii=False, indent=2)`  
  - CSV download:
    - `pd.DataFrame([app_dict]).to_csv(index=False)`  

---

### 7.2 WOW Application Completeness Indicator

`compute_tw_app_completeness()` evaluates the filling status of key fields:

- Required fields include core identifiers (e.g., `tw_e_no`, `tw_case_type`, `tw_dev_name_zh`, etc.).  
- Computes `filled / total_required` to return a float [0,1].

The tab then displays:

- A WOW card with gradient color:
  - Green (≥ 80%): high completeness  
  - Orange (≥ 50%): medium  
  - Red (< 50%): low completeness  
- A brief textual hint about readiness for pre-screening.  
- A Streamlit progress bar reflecting completeness.

---

### 7.3 Application Form UI

The form is grouped into sections:

1. **Case Basic Info**: case type, device category, origin, etc.  
2. **Device Basic Info**: Chinese/English name, indications, model/spec.  
3. **Classification / Grading Items**: main category, item code/name.  
4. **Firm Info**: unified ID, name, address, responsible person, contact.  
5. **Manufacturer Info**: manufacturer name, country, address, notes; manufacturing type (single, full contract, partial).  
6. **Attachment Summaries**:  
   - Authorization letter, country of sale certificate, QMS/QSD.  
   - Similar devices, labeling, technical file summarization.  
   - Preclinical testing & QC, alternatives, clinical evidence summary.

All fields are bound to `st.session_state["tw_*"]` keys, which are also the basis for JSON/CSV export and the application Markdown.

### 7.4 Application Markdown Generation

On clicking “生成申請書 Markdown 草稿”:

- Performs basic completeness checks on required fields (warning if missing).  
- Builds an application Markdown string `app_md` with headings and bullet lists covering sections 1–18, following TFDA structure.  
- Stores `app_md` in `st.session_state["tw_app_markdown"]`.  
- Provides an editable view (Markdown/plain text toggle) whose effective content is stored in `st.session_state["tw_app_effective_md"]`.

---

### 7.5 Guidance Input (Pre-screening Guidance)

- User can upload guidance as PDF / TXT / MD, or paste directly.  
- PDF is converted to text via `extract_pdf_pages_to_text`.  
- The guidance text is combined and stored in `st.session_state["tw_guidance_text"]`.  
- If no guidance is provided, the pre-screening agent falls back to generic regulatory logic.

---

### 7.6 Form-Based Pre-screening (tw_screen_review_agent)

Uses `agent_run_ui` with:

- `agent_id="tw_screen_review_agent"`  
- Default prompt describing responsibilities of a TFDA pre-screening officer:  
  - Completeness table of required documents.  
  - Major field checks and suspicion of inconsistencies.  
  - Pre-screening summary with “must fix” vs “nice to have” suggestions.

Inputs:

- Applicant’s application Markdown (`tw_app_effective_md`)  
- Guidance text (`tw_guidance_text`)  

Users can override model, max_tokens, prompt. Output is editable Markdown.

---

### 7.7 Application Document Helper (tw_app_doc_helper)

Also via `agent_run_ui`:

- `agent_id="tw_app_doc_helper"`  
- Uses the application Markdown as input.  
- Improves:
  - Document structure and headings.  
  - Language clarity (without altering underlying facts).  
  - Marks missing information with `※待補：...`.

Again, model and prompt can be overridden, and output is editable.

---

## 8. 510(k) Intelligence & Review Pipeline

### 8.1 510(k) Tab

`render_510k_tab()`:

- Collects basic 510(k)-related inputs (device name, K number, sponsor, product code).  
- Constructs a prompt instructing a summary of public information with a 2000–3000 word review-style document and multiple tables.  
- Invokes `agent_run_ui` with `agent_id="fda_510k_intel_agent"`.  

### 8.2 PDF → Markdown

`render_pdf_to_md_tab()`:

- Uploads a PDF, selects page range, extracts text with `pypdf`.  
- Calls `agent_run_ui("pdf_to_markdown_agent", ...)` to convert raw text to clean Markdown.  
- All standard agent override features are available.

### 8.3 510(k) Review Pipeline

`render_510k_review_pipeline_tab()` provides a simplified pipeline:

1. **Submission structuring**:
   - Paste submission text.  
   - LLM reorganizes it into structured Markdown with separate sections.  

2. **Checklist & Review Report**:
   - Paste or produce a checklist.  
   - Combined with structured submission, LLM drafts a concise internal 510(k) review memo.  

The pipeline uses direct `call_llm` calls (not the generic agent runner) but still logs events to history.

---

## 9. Note Keeper & Magics

`render_note_keeper_tab()` manages reviewer notes:

- **Step 1**: Note → structured Markdown (`call_llm` with user-configured model and prompt).  
- Stores result in `note_md` and `note_effective`.  

- **Magic 1 – AI Formatting**:  
  - Formats notes only (no content change).  

- **Magic 2 – AI Keywords (Manual highlight)**:  
  - User supplies keywords and color; `highlight_keywords()` injects HTML spans in Markdown.  

- **Magic 3 – AI Summary**:  
  - Produces bullet-point + paragraph summary for management.  

- **Magic 4 – AI Action Items**:  
  - Extracts follow-up actions with a table (action, owner, priority, note).  

- **Magic 5 – AI Glossary**:  
  - Builds a term table with English names and Chinese explanations.

All results are editable in text areas and persist in `st.session_state`.

---

## 10. Agents Config Studio

`render_agents_config_tab()`:

- Displays current agents overview (from `st.session_state["agents_cfg"]["agents"]`).  
- Provides a raw YAML editor with:
  - Apply changes to session.  
  - Upload new `agents.yaml`.  
  - Download current `agents.yaml`.  

This allows fine-tuning system prompts, user prompt templates, and default models without changing the actual code.

---

## 11. Session Management and Defaults

On startup:

- `st.session_state["settings"]` is initialized with light theme, Traditional Chinese UI, default painter style, default model `gpt-4o-mini`, `max_tokens=12000`, temperature 0.2.  
- `st.session_state["history"]` is initialized as an empty list.  
- `agents.yaml` is loaded from local file, else a minimal fallback with key agents is used.

---

## 12. Deployment Considerations

- Designed for **Hugging Face Spaces** (or any Streamlit-compatible deployment).  
- `requirements.txt` must include all libraries used in `app.py`.  
- Environment variables for API keys:
  - `OPENAI_API_KEY`
  - `GEMINI_API_KEY`
  - `ANTHROPIC_API_KEY`
  - `GROK_API_KEY`  

Security considerations:

- API keys entered in sidebar are not persisted server-side across sessions (only in `st.session_state`).  
- No code writes these keys to disk.  
- Application info import/export is plain JSON/CSV; no encryption is applied by default, so secure deployment and storage practices are recommended.

---

## 13. Extensibility

Future enhancements can be easily integrated by:

- Adding new agents to `agents.yaml`.  
- Creating new tab renderers that call `agent_run_ui` with those agents.  
- Expanding the TFDA or 510(k) pipelines with more steps (e.g., risk management overlays, SE arguments analysis).  
- Integrating additional model providers by extending `get_provider()` and `call_llm()`.

The current design already supports chaining agent outputs (via editable text areas), multi-model runs, and dynamic YAML-based agent specification, providing a flexible base for advanced regulatory workflows.
